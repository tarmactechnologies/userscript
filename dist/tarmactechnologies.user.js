// ==UserScript==
// @name         Tarmac Technologies
// @version      3.2.1
// @author       Tarmac Technologies
// @description  Miscellaneous Tarmac Technologies Utilities
// @icon         https://static-tarmac.s3.amazonaws.com/img/favicon.ico
// @downloadURL  https://github.com/tarmactechnologies/userscript/raw/main/dist/tarmactechnologies.user.js
// @updateURL    https://github.com/tarmactechnologies/userscript/raw/main/dist/tarmactechnologies.meta.js
// @match        https://backoffice.tarmactechnologies.com/*
// @match        https://dev-backoffice.tarmactechnologies.com/*
// @match        https://admin.tarmactechnologies.com/*
// @match        https://dev-admin.tarmactechnologies.com/*
// @match        https://agoa.tarmactechnologies.com/*
// @match        https://dev-agoa.tarmactechnologies.com/*
// @match        https://staging-agoa.tarmactechnologies.com/*
// ==/UserScript==

(function () {
	'use strict';

	function $(){const r=document.querySelector('label[for="id_business_groups"]'),o=document.querySelector('select[name="business_groups"]'),s=document.querySelector('input[name="name"]').value,t=[[r,o,()=>s]];for(const e of document.querySelectorAll('select[name$="-business_groups"]')){e.insertAdjacentHTML("afterend",`<span class="related-widget-wrapper-link add-related" id="popup-${e.id}" title="Add another Company Business Group"><img src="https://static-tarmac.s3.amazonaws.com/admin/img/icon-yes.svg" alt="Popup"></span>`);const n=document.getElementById(`popup-${e.id}`);t.push([n,e,()=>document.querySelector(`select[name="${e.name.match(/^(.*)-business_groups$/)[1]}-related_company"]`).selectedOptions[0].innerHTML+" (related)"]);}for(const[e,n,l]of t){let c=function(m){for(const a of n.options)a.selected=!1;for(let a of m){if(a=a.trim().toUpperCase().match(/([A-Z0-9]{2}).*([A-Z]{3})/),!a)continue;a=`${a[1]} - ${a[2]}`;const u=Array.from(n.options).find(g=>g.label===a);u===void 0?console.warn(`[TT Userscript] Cound not find company business group ${a}`):u.selected=!0;}};e.addEventListener("click",()=>{const m=Array.from(n.options).filter(u=>u.selected).map(u=>u.label),a=window.open("","","width=800, height=400");a.document.title=`${l()} | Company Business Groups`,a.document.body.innerHTML=`<label for="cbg" style="display: block;">Company Business Groups</label><textarea type="text" name="cbg" id="cbg" style="width: 100%; height: calc(100% - 60px); margin-bottom: 15px;">${m.join(`
`)}</textarea><br><button id="submit">Submit</button>`,a.document.querySelector("#submit").addEventListener("click",()=>{c(a.document.querySelector("#cbg").value.split(`
`)),a.close();}),window.addEventListener("beforeunload",()=>{a.close();}),a.document.addEventListener("keydown",u=>{u.ctrlKey&&u.key==="Enter"&&a.document.querySelector("#submit").click(),u.key==="Escape"&&a.close();});}),e.style="cursor: pointer; user-select: none;";}}function _(){$(),console.log("[TT Userscript] Companies module loaded");}function E(){const r=document.querySelector('label[for="id_airlines"]'),o=document.querySelector('select[name="airlines"]'),s=document.querySelector('input[name="information_code"]').value;function t(i){for(const e of o.options)e.selected=!1;for(let e of i){if(e=e.trim().toUpperCase(),!e)continue;const n=Array.from(o.options).find(l=>l.label.substring(0,2)===e);n===void 0?console.warn(`[TT Userscript] Cound not find airline ${e}`):n.selected=!0;}}r.addEventListener("click",()=>{const i=Array.from(o.options).filter(n=>n.selected).map(n=>n.label.substring(0,2)),e=window.open("","","width=400, height=400");e.document.title=`${s} | Airlines`,e.document.body.innerHTML=`<label for="cbg" style="display: block;">Airlines</label><textarea type="text" name="airlines" id="airlines" style="width: 100%; height: calc(100% - 60px); margin-bottom: 15px;">${i.join(`
`)}</textarea><br><button id="submit">Submit</button>`,e.document.querySelector("#submit").addEventListener("click",()=>{t(e.document.querySelector("#airlines").value.split(`
`)),e.close();}),window.addEventListener("beforeunload",()=>{e.close();}),e.document.addEventListener("keydown",n=>{n.ctrlKey&&n.key==="Enter"&&e.document.querySelector("#submit").click(),n.key==="Escape"&&e.close();});}),r.style="cursor: pointer; user-select: none;";}function C(){const r=document.querySelector('label[for="id_airports"]'),o=document.querySelector('select[name="airports"]'),s=document.querySelector('input[name="information_code"]').value;function t(i){for(const e of o.options)e.selected=!1;for(let e of i){if(e=e.trim().toUpperCase(),!e)continue;const n=Array.from(o.options).find(l=>l.label.substring(0,3)===e);n===void 0?console.warn(`[TT Userscript] Cound not find airport ${e}`):n.selected=!0;}}r.addEventListener("click",()=>{const i=Array.from(o.options).filter(n=>n.selected).map(n=>n.label.substring(0,3)),e=window.open("","","width=400, height=400");e.document.title=`${s} | Airlines`,e.document.body.innerHTML=`<label for="cbg" style="display: block;">Airports</label><textarea type="text" name="airports" id="airports" style="width: 100%; height: calc(100% - 60px); margin-bottom: 15px;">${i.join(`
`)}</textarea><br><button id="submit">Submit</button>`,e.document.querySelector("#submit").addEventListener("click",()=>{t(e.document.querySelector("#airports").value.split(`
`)),e.close();}),window.addEventListener("beforeunload",()=>{e.close();}),e.document.addEventListener("keydown",n=>{n.ctrlKey&&n.key==="Enter"&&e.document.querySelector("#submit").click(),n.key==="Escape"&&e.close();});}),r.style="cursor: pointer; user-select: none;";}function T(){E(),C(),console.log("[TT Userscript] Partner Task Rules module loaded");}function I(){const r=document.querySelector('label[for="id_company_business_groups"]'),o=document.querySelector('select[name="company_business_groups"]'),s=document.querySelector('input[name="username"]').value;function t(i){for(const e of o.options)e.selected=!1;for(let e of i){if(e=e.trim().toUpperCase().match(/([A-Z0-9]{2}).*([A-Z]{3})/),!e)continue;e=`${e[1]} - ${e[2]}`;const n=Array.from(o.options).find(l=>l.label===e);n===void 0?console.warn(`[TT Userscript] Cound not find company business group ${e}`):n.selected=!0;}}r.addEventListener("click",()=>{const i=Array.from(o.options).filter(n=>n.selected).map(n=>n.label),e=window.open("","","width=800, height=400");e.document.title=`${s} | Company Business Groups`,e.document.body.innerHTML=`<label for="cbg" style="display: block;">Company Business Groups</label><textarea type="text" name="cbg" id="cbg" style="width: 100%; height: calc(100% - 60px); margin-bottom: 15px;">${i.join(`
`)}</textarea><br><button id="submit">Submit</button>`,e.document.querySelector("#submit").addEventListener("click",()=>{t(e.document.querySelector("#cbg").value.split(`
`)),e.close();}),window.addEventListener("beforeunload",()=>{e.close();}),e.document.addEventListener("keydown",n=>{n.ctrlKey&&n.key==="Enter"&&e.document.querySelector("#submit").click(),n.key==="Escape"&&e.close();});}),r.style="cursor: pointer; user-select: none;";}function L(){I(),console.log("[TT Userscript] User CBGs module loaded");}function U(){const r=document.querySelector("#content");if(!r){console.error("Impossible de trouver le conteneur pour ajouter les boutons.");return}if(document.getElementById("uploadExcelButton"))return;const o=document.createElement("button"),s=document.createElement("button"),t=document.createElement("input");o.id="uploadExcelButton",s.id="stopButton",t.id="fileInput",o.innerText="Upload Excel",s.innerText="Stop",t.type="file",t.accept=".xlsx",t.style.display="none",o.style.marginRight="10px",o.addEventListener("click",()=>t.click()),t.addEventListener("change",async i=>{const e=i.target.files[0];if(e){const n=await B(e);localStorage.setItem("excelData",JSON.stringify(n)),localStorage.setItem("automationState","1"),localStorage.setItem("currentRowIndex","0"),alert("Données importées et état activé."),A();}}),s.addEventListener("click",()=>{localStorage.setItem("automationState","0"),alert("État désactivé. Importation arrêtée.");}),r.prepend(s),r.prepend(o),r.prepend(t);}async function B(r){const o=await r.arrayBuffer(),s=XLSX.read(o,{type:"array"}),t=s.Sheets[s.SheetNames[0]];return XLSX.utils.sheet_to_json(t)}const q=document.createElement("script");q.src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js";document.head.appendChild(q);function F(){const r=window.location.href,o=JSON.parse(localStorage.getItem("excelData")||"[]"),s=parseInt(localStorage.getItem("currentRowIndex"),10);r.includes("/users/customuser/add/")&&s>=o.length&&(alert("✅ Importation terminée ! Tous les utilisateurs ont été traités avec succès."),console.log("✅ Importation terminée. Processus réinitialisé."),localStorage.setItem("automationState","0"),localStorage.setItem("currentRowIndex","0"));}function G(){let r=parseInt(localStorage.getItem("currentRowIndex"),10);r+=1,localStorage.setItem("currentRowIndex",r.toString()),console.log(`Index incrémenté : Nouvel index = ${r}`);}function R(){if(localStorage.getItem("automationState")==="1"){const o=parseInt(localStorage.getItem("currentRowIndex"),10),s=JSON.parse(localStorage.getItem("excelData")||"[]");if(o<s.length){const t=s[o];console.log(`Traitement de la première page pour la ligne ${o} :`,t);const i=document.querySelector("#id_username"),e=document.querySelector("#id_password1"),n=document.querySelector("#id_password2"),l=document.querySelector("#id_company");if(i&&e&&n&&l){i.value=t.username||"",e.value=t.password||"",n.value=t.password||"",k(l,t.company||"")||console.error(`Erreur lors du remplissage de la position : ${t.company}`),console.log(`Champs remplis (Première Page) : Username = ${t.username}, Password = ${t.password}`);const m=document.querySelector('input[name="_continue"]');m?(G(),m.click()):console.error('Bouton "Save and continue editing" introuvable.');}else console.error("Un ou plusieurs champs de la première page sont introuvables.");}else F();}}function P(){localStorage.getItem("automationState")==="1"&&setTimeout(()=>{const o=parseInt(localStorage.getItem("currentRowIndex"),10),s=JSON.parse(localStorage.getItem("excelData")||"[]");if(o>0&&o-1<s.length){const t=s[o-1];console.log(`Traitement de la seconde page pour la ligne ${o-1} :`,t);const i=document.querySelector("#id_first_name"),e=document.querySelector("#id_last_name"),n=document.querySelector("#id_email"),l=document.querySelector("#id_username"),c=document.querySelector("#id_position"),m=document.querySelector("#id_company"),a=document.querySelector("#id_weight"),u=document.querySelector("#id_company_business_groups"),g=document.querySelector("#id_business_groups"),w=document.querySelector("#id_groups_from");if(document.querySelector("#id_groups_add_link"),i&&e&&n&&(i.value=t.firstName||"",e.value=t.lastName||"",n.value=t.email||"",console.log(`Champs texte remplis : First Name = ${t.firstName}, Last Name = ${t.lastName}, Email = ${t.email}`)),l&&(l.value=t.username||"",console.log(`Username rempli : ${t.username}`)),a&&(a.value=t.weight||"",console.log(`Poids rempli : ${t.weight}`)),c&&(k(c,t.position||"")||console.error(`Erreur lors du remplissage de la position : ${t.position}`)),m&&(k(m,t.company||"")||console.error(`Erreur lors du remplissage de la compagnie : ${t.company}`)),u){const b=(t.companyBusinessGroups||"").split(",").map(p=>p.trim().replace(/\s+/g,"")),d=u.options;for(let p=0;p<d.length;p++)d[p].selected=!1;b.forEach(p=>{let y=!1;for(let f=0;f<d.length;f++){const S=d[f].textContent.trim().replace(/\s+/g,""),v=d[f].value.trim().replace(/\s+/g,""),x=p.toUpperCase();if(S.toUpperCase()===x||v.toUpperCase()===x){d[f].selected=!0,y=!0,console.log(`Company Business Group sélectionné : ${p}`);break}}y||console.error(`Company Business Group "${p}" introuvable dans le menu déroulant.`);});}else console.error('Champ "Company Business Groups" introuvable.');if(w){const b=(t.businessGroupsPositions||"").split(",").map(d=>d.trim());if(b.length>0){const d=w.options;b.forEach(p=>{let y=!1;for(let f=0;f<d.length;f++){const S=d[f].textContent.trim().toUpperCase(),v=p.toUpperCase();if(S===v){d[f].selected=!0,O(d[f]),console.log(`Group déplacé vers "Chosen Groups" : ${p}`),y=!0;break}}y||console.error(`Group "${p}" introuvable dans les "Available Groups".`);});}else console.error("Aucun groupe spécifié dans les données.");}else console.error('Champ "Available Groups" introuvable.');if(g){const b=(t.businessGroupsAirports||"").split(",").map(y=>`AIRPORT  ${y.trim()}`),d=(t.businessGroupsAirlines||"").split(",").map(y=>`AIRLINE  ${y.trim()}`),p=[...b,...d];N(g,p.join(","));}const h=document.querySelector('input[name="_addanother"]');h?h.click():console.error('Bouton "Save and add another" introuvable.');}},2e3);}function k(r,o){if(!r)return console.error("Menu déroulant introuvable."),!1;const s=r.querySelectorAll("option");for(let t of s)if(t.textContent.trim()===o||t.value===o)return t.selected=!0,console.log(`Option sélectionnée : ${t.textContent}`),!0;return console.error(`Valeur "${o}" introuvable dans le menu déroulant.`),!1}function N(r,o){if(!r){console.error("Champ multisélection introuvable.");return}const s=o.split(",").map(i=>i.trim().toUpperCase()),t=r.options;for(let i=0;i<t.length;i++)t[i].selected=!1;s.forEach(i=>{let e=!1;for(let n=0;n<t.length;n++){const l=t[n].textContent.trim().toUpperCase(),c=t[n].value.trim().toUpperCase();if(l===i||c===i){t[n].selected=!0,e=!0,console.log(`Valeur sélectionnée : ${i}`);break}}e||console.error(`Valeur "${i}" introuvable dans le champ multisélection.`);});}function O(r){if(!r)return;const o=new MouseEvent("dblclick",{bubbles:!0,cancelable:!0,view:window});r.dispatchEvent(o);}function A(){const r=window.location.href;r.includes("/users/customuser/add/")?(U(),R()):r.includes("/users/customuser/")&&!r.includes("/add/")&&P();}function D(){A(),console.log("[TT Userscript] Users excel upload module loaded");}function M(r="admin"){function o(){Array.from(document.querySelectorAll('[id^="TurnaroundPathAirportsHubActual"]')).forEach(t=>{if(!t.dataset.processed){const i=t.id.match(/TurnaroundPathAirportsHubActual([0-9]+)/)[1];t.addEventListener("click",()=>{window.open(`https://${r}.tarmactechnologies.com/tarmac/turnaround/${i}`);}),t.style="cursor: pointer; user-select: none;",t.dataset.processed=!0;}}),Array.from(document.querySelectorAll(".station-selected-turnarounds__turnarounds-details__turnaround-details .ui-badge")).forEach(t=>{if(!t.dataset.processed){const i=t.id.match(/turnaround-details-badge-([0-9]+)/)[1];t.addEventListener("click",()=>{window.open(`https://metabase.tarmactechnologies.com/dashboard/7-turnaround-deepdive?turnaround_id=${i}`);}),t.style="cursor: pointer; user-select: none;",t.dataset.processed=!0;}});}function s(){new MutationObserver(t=>{t.forEach(i=>{i.addedNodes.length&&o();});}).observe(document.body,{childList:!0,subtree:!0});}o(),s(),console.log("[TT Userscript] Module loaded");}function j(){function r(o,s){const t=document.evaluate('.//label[contains(., "Task Additional Information")]',s,null,XPathResult.ANY_TYPE,null).iterateNext();if(!t){console.error("[TT Userscript] Add info label not found");return}function i(e,n){const l=n.split(`
`).map(c=>c.split(",")[0]);if(l.some((c,m)=>l.indexOf(c)<m))return e.alert("Duplicate hard labels not allowed!"),!1;for(const c of s.querySelectorAll(".task-additional-information-tbody button.delete-task-additional-information"))c.click();for(const[c,m]of n.split(`
`).entries()){if(m.trim()==="")continue;const a=m.split(",");if(a.length<3)return e.alert("Three or four columns required!"),!1;c>0&&s.querySelector(".add-task-additional-information").click();const[u,g,w]=a,h=Array.from(s.querySelectorAll(".task-additional-information-tbody tr")).at(-1),b=h.querySelector(`select[name="normal-${o}-task-additional-information-label-id"]`),d=Array.from(b.options).find(S=>S.label.toLowerCase()===u.toLowerCase());d===void 0?console.warn(`[TT Userscript] Could not find label ${u}`):d.selected=!0;const p=h.querySelector(`input[name="normal-${o}-task-additional-information-custom-label"]`);p.value=g;const y=h.querySelector(`select[name="normal-${o}-task-additional-information-type"]`),f=Array.from(y.options).find(S=>S.label.toLowerCase()===w.toLowerCase());if(f===void 0?console.warn(`[TT Userscript] Could not find type ${w}`):f.selected=!0,a.length>3){const S=a[3].toLowerCase()==="true";h.querySelector('input[type="checkbox"]').checked=S;}}return !0}t.addEventListener("click",()=>{const e=window.open("","","width=800, height=400, scrollbars=yes");e.document.body.innerHTML='<textarea name="addinfos" id="addinfos" rows="10" style="display: block; height: calc(100% - 20px); width: 100%; padding: 5px;"></textarea><button id="submit">Submit</button>';let n="";for(const c of s.querySelectorAll(".task-additional-information-tbody tr")){const m=c.querySelector(`select[name="normal-${o}-task-additional-information-label-id"]`).selectedOptions,a=m.length>0?m[0].label:"",u=c.querySelector(`input[name="normal-${o}-task-additional-information-custom-label"]`).value,g=c.querySelector(`select[name="normal-${o}-task-additional-information-type"]`).selectedOptions,w=g.length>0?g[0].label:"",h=c.querySelector('input[type="checkbox"]').checked?"true":"false";n+=`${a},${u},${w},${h}
`;}n===`,,Checkbox,false
`&&(n="");const l=e.document.getElementById("addinfos");l.value=n,e.document.getElementById("submit").addEventListener("click",()=>{i(e,l.value)&&e.close();});}),t.style="cursor: pointer; user-select: none;";}for(const o of ["above","below"])for(const s of document.querySelectorAll(`#normal-${o}-table-body tr.row-id`))r(o,s);document.querySelector('button[data-action="add"][data-target="#normal-above-table"]').addEventListener("click",o=>{o.stopPropagation(),addRow("#normal-above-table");const s=Array.from(document.querySelectorAll("#normal-above-table-body tr.row-id")).at(-1);r("above",s);}),document.querySelector('button[data-action="add"][data-target="#normal-below-table"]').addEventListener("click",o=>{o.stopPropagation(),addRow("#normal-below-table");const s=Array.from(document.querySelectorAll("#normal-below-table-body tr.row-id")).at(-1);r("below",s);}),console.log("[TT Userscript] Critical path module loaded");}function H(r="admin"){new MutationObserver(s=>{for(const t of s)if(t.type==="childList")for(const i of t.addedNodes){const e=i.querySelector("a").href.match(/\/([0-9]+)\//)[1],n=i.children[1];n.addEventListener("click",()=>{window.open(`https://${r}.tarmactechnologies.com/users/customuser/${e}`);}),n.style="cursor: pointer; user-select: none;";}}).observe(document.querySelector("#users-list tbody"),{childList:!0,subtree:!0}),console.log("[TT Userscript] Users module loaded");}(function(){const r=window.location.hostname,o=window.location.pathname;/^(?:dev-)?backoffice.tarmactechnologies.com$/.test(r)&&(/^\/(?:specific_)?critical_path\/(?:[0-9]+\/)?(?:edit|add|new)/.test(o)&&j(),/\/users/i.test(o)&&H(/^dev-backoffice/.test(r)?"dev-admin":"admin")),/^(?:dev-)?admin.tarmactechnologies.com$/.test(r)&&(/^\/users\/customuser\/[0-9]+\/change/.test(o)&&L(),/^\/users\/customuser\//.test(o)&&D(),/^\/tarmac\/company\/(?:[0-9]+\/change|add)/.test(o)&&_(),/^\/tarmac\/partnertaskrule\/(?:add|[0-9]+\/change)/.test(o)&&T()),/(?:dev-|staging-)?agoa.tarmactechnologies.com/.test(r)&&/^\/(?:agoa|station)?$/.test(o)&&M(/^dev-agoa/.test(r)?"dev-admin":"admin");})();

})();