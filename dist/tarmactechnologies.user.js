// ==UserScript==
// @name         Tarmac Technologies
// @version      3.1.2
// @author       Tarmac Technologies
// @description  Miscellaneous Tarmac Technologies Utilities
// @icon         https://static-tarmac.s3.amazonaws.com/img/favicon.ico
// @downloadURL  https://github.com/tarmactechnologies/userscript/raw/main/dist/tarmactechnologies.user.js
// @updateURL    https://github.com/tarmactechnologies/userscript/raw/main/dist/tarmactechnologies.meta.js
// @match        https://backoffice.tarmactechnologies.com/*
// @match        https://dev-backoffice.tarmactechnologies.com/*
// @match        https://admin.tarmactechnologies.com/*
// @match        https://dev-admin.tarmactechnologies.com/*
// @match        https://agoa.tarmactechnologies.com/*
// @match        https://dev-agoa.tarmactechnologies.com/*
// ==/UserScript==

(function () {
	'use strict';

	function S(){const a=document.querySelector('label[for="id_business_groups"]'),s=document.querySelector('select[name="business_groups"]'),c=document.querySelector('input[name="name"]').value,r=[[a,s,()=>c]];for(const e of document.querySelectorAll('select[name$="-business_groups"]')){e.insertAdjacentHTML("afterend",`<span class="related-widget-wrapper-link add-related" id="popup-${e.id}" title="Add another Company Business Group"><img src="https://static-tarmac.s3.amazonaws.com/admin/img/icon-yes.svg" alt="Popup"></span>`);const t=document.getElementById(`popup-${e.id}`);r.push([t,e,()=>document.querySelector(`select[name="${e.name.match(/^(.*)-business_groups$/)[1]}-related_company"]`).selectedOptions[0].innerHTML+" (related)"]);}for(const[e,t,u]of r){let d=function(n){for(const o of t.options)o.selected=!1;for(let o of n){if(o=o.trim().toUpperCase().match(/([A-Z0-9]{2}).*([A-Z]{3})/),!o)continue;o=`${o[1]} - ${o[2]}`;const l=Array.from(t.options).find(p=>p.label===o);l===void 0?console.warn(`[TT Userscript] Cound not find company business group ${o}`):l.selected=!0;}};e.addEventListener("click",()=>{const n=Array.from(t.options).filter(l=>l.selected).map(l=>l.label),o=window.open("","","width=800, height=400");o.document.title=`${u()} | Company Business Groups`,o.document.body.innerHTML=`<label for="cbg" style="display: block;">Company Business Groups</label><textarea type="text" name="cbg" id="cbg" style="width: 100%; height: calc(100% - 60px); margin-bottom: 15px;">${n.join(`
`)}</textarea><br><button id="submit">Submit</button>`,o.document.querySelector("#submit").addEventListener("click",()=>{d(o.document.querySelector("#cbg").value.split(`
`)),o.close();}),window.addEventListener("beforeunload",()=>{o.close();}),o.document.addEventListener("keydown",l=>{l.ctrlKey&&l.key==="Enter"&&o.document.querySelector("#submit").click(),l.key==="Escape"&&o.close();});}),e.style="cursor: pointer; user-select: none;";}}function A(){S(),console.log("[TT Userscript] Companies module loaded");}function T(){const a=document.querySelector('label[for="id_airlines"]'),s=document.querySelector('select[name="airlines"]'),c=document.querySelector('input[name="information_code"]').value;function r(i){for(const e of s.options)e.selected=!1;for(let e of i){if(e=e.trim().toUpperCase(),!e)continue;const t=Array.from(s.options).find(u=>u.label.substring(0,2)===e);t===void 0?console.warn(`[TT Userscript] Cound not find airline ${e}`):t.selected=!0;}}a.addEventListener("click",()=>{const i=Array.from(s.options).filter(t=>t.selected).map(t=>t.label.substring(0,2)),e=window.open("","","width=400, height=400");e.document.title=`${c} | Airlines`,e.document.body.innerHTML=`<label for="cbg" style="display: block;">Airlines</label><textarea type="text" name="airlines" id="airlines" style="width: 100%; height: calc(100% - 60px); margin-bottom: 15px;">${i.join(`
`)}</textarea><br><button id="submit">Submit</button>`,e.document.querySelector("#submit").addEventListener("click",()=>{r(e.document.querySelector("#airlines").value.split(`
`)),e.close();}),window.addEventListener("beforeunload",()=>{e.close();}),e.document.addEventListener("keydown",t=>{t.ctrlKey&&t.key==="Enter"&&e.document.querySelector("#submit").click(),t.key==="Escape"&&e.close();});}),a.style="cursor: pointer; user-select: none;";}function q(){const a=document.querySelector('label[for="id_airports"]'),s=document.querySelector('select[name="airports"]'),c=document.querySelector('input[name="information_code"]').value;function r(i){for(const e of s.options)e.selected=!1;for(let e of i){if(e=e.trim().toUpperCase(),!e)continue;const t=Array.from(s.options).find(u=>u.label.substring(0,3)===e);t===void 0?console.warn(`[TT Userscript] Cound not find airport ${e}`):t.selected=!0;}}a.addEventListener("click",()=>{const i=Array.from(s.options).filter(t=>t.selected).map(t=>t.label.substring(0,3)),e=window.open("","","width=400, height=400");e.document.title=`${c} | Airlines`,e.document.body.innerHTML=`<label for="cbg" style="display: block;">Airports</label><textarea type="text" name="airports" id="airports" style="width: 100%; height: calc(100% - 60px); margin-bottom: 15px;">${i.join(`
`)}</textarea><br><button id="submit">Submit</button>`,e.document.querySelector("#submit").addEventListener("click",()=>{r(e.document.querySelector("#airports").value.split(`
`)),e.close();}),window.addEventListener("beforeunload",()=>{e.close();}),e.document.addEventListener("keydown",t=>{t.ctrlKey&&t.key==="Enter"&&e.document.querySelector("#submit").click(),t.key==="Escape"&&e.close();});}),a.style="cursor: pointer; user-select: none;";}function $(){T(),q(),console.log("[TT Userscript] Partner Task Rules module loaded");}function v(){const a=document.querySelector('label[for="id_business_groups"]'),s=document.querySelector('select[name="business_groups"]'),c=document.querySelector('input[name="username"]').value;function r(i,e,t,u,d){for(const n of s.options)n.selected=!1;for(const n of i){if(!n)continue;const o=Array.from(s.options).find(l=>l.label===`AIRLINE ${n.toUpperCase()}`);o===void 0?console.warn(`[TT Userscript] Cound not find airline ${n}`):o.selected=!0;}for(const n of e){if(!n)continue;const o=Array.from(s.options).find(l=>l.label===`AIRPORT ${n.toUpperCase()}`);o===void 0?console.warn(`[TT Userscript] Cound not find airport ${n}`):o.selected=!0;}for(const n of t){if(!n)continue;const o=Array.from(s.options).find(l=>l.label===`HANDLER ${n.toUpperCase()}`);o===void 0?console.warn(`[TT Userscript] Cound not find handler ${n}`):o.selected=!0;}for(const n of u){if(!n)continue;const o=Array.from(s.options).find(l=>l.label===`POSITION ${n.toUpperCase()}`);o===void 0?console.warn(`[TT Userscript] Cound not find position ${n}`):o.selected=!0;}for(const n of d){const o=Array.from(s.options).find(l=>l.label===n);o===void 0?console.error(`[TT Userscript] Could not find business group ${n}`):o.selected=!0;}}a.addEventListener("click",()=>{const i=[],e=[],t=[],u=[],d=[];for(const o of s.options){if(!o.selected)continue;const[l,p]=o.label.split(" ");switch(l){case"AIRLINE":i.push(p);break;case"AIRPORT":e.push(p);break;case"HANDLER":t.push(p);break;case"POSITION":u.push(p);break;default:console.warn(`Unknown business group type ${l} (name = ${p})`),d.push(o.label);}}const n=window.open("","","width=800, height=400, scrollbars=yes");n.document.title=`${c} | Business Groups`,n.document.body.innerHTML=`<label for="airlines" style="display: block;">Airlines</label><input type="text" name="airlines" id="airlines" value="${i.join(",")}" style="width: 100%; margin-bottom: 15px;" /><br>`,n.document.body.innerHTML+=`<label for="airports" style="display: block;">Airports</label><input type="text" name="airports" id="airports" value="${e.join(",")}" style="width: 100%; margin-bottom: 15px;" /><br>`,n.document.body.innerHTML+=`<label for="handlers" style="display: block;">Handlers</label><input type="text" name="handlers" id="handlers" value="${t.join(",")}" style="width: 100%; margin-bottom: 15px;" /><br>`,n.document.body.innerHTML+=`<label for="positions" style="display: block;">Positions</label><input type="text" name="positions" id="positions" value="${u.join(",")}" style="width: 100%; margin-bottom: 15px;" /><br>`,n.document.body.innerHTML+='<button id="submit">Submit</button>',n.document.querySelector("#submit").addEventListener("click",()=>{r(n.document.querySelector("#airlines").value.split(/[ ,]+/),n.document.querySelector("#airports").value.split(/[ ,]+/),n.document.querySelector("#handlers").value.split(/[ ,]+/),n.document.querySelector("#positions").value.split(/[ ,]+/),d),n.close();}),window.addEventListener("beforeunload",()=>{n.close();}),n.document.addEventListener("keydown",o=>{o.ctrlKey&&o.key==="Enter"&&n.document.querySelector("#submit").click(),o.key==="Escape"&&n.close();});}),a.style="cursor: pointer; user-select: none;";}function L(){const a=document.querySelector('label[for="id_company_business_groups"]'),s=document.querySelector('select[name="company_business_groups"]'),c=document.querySelector('input[name="username"]').value;function r(i){for(const e of s.options)e.selected=!1;for(let e of i){if(e=e.trim().toUpperCase().match(/([A-Z0-9]{2}).*([A-Z]{3})/),!e)continue;e=`${e[1]} - ${e[2]}`;const t=Array.from(s.options).find(u=>u.label===e);t===void 0?console.warn(`[TT Userscript] Cound not find company business group ${e}`):t.selected=!0;}}a.addEventListener("click",()=>{const i=Array.from(s.options).filter(t=>t.selected).map(t=>t.label),e=window.open("","","width=800, height=400");e.document.title=`${c} | Company Business Groups`,e.document.body.innerHTML=`<label for="cbg" style="display: block;">Company Business Groups</label><textarea type="text" name="cbg" id="cbg" style="width: 100%; height: calc(100% - 60px); margin-bottom: 15px;">${i.join(`
`)}</textarea><br><button id="submit">Submit</button>`,e.document.querySelector("#submit").addEventListener("click",()=>{r(e.document.querySelector("#cbg").value.split(`
`)),e.close();}),window.addEventListener("beforeunload",()=>{e.close();}),e.document.addEventListener("keydown",t=>{t.ctrlKey&&t.key==="Enter"&&e.document.querySelector("#submit").click(),t.key==="Escape"&&e.close();});}),a.style="cursor: pointer; user-select: none;";}function E(){v(),L(),console.log("[TT Userscript] Users module loaded");}function C(a="admin"){function s(){Array.from(document.querySelectorAll('[id^="TurnaroundPathAirportsHubActual"]')).forEach(r=>{if(!r.dataset.processed){const i=r.id.match(/TurnaroundPathAirportsHubActual([0-9]+)/)[1];r.addEventListener("click",()=>{window.open(`https://${a}.tarmactechnologies.com/tarmac/turnaround/${i}`);}),r.style="cursor: pointer; user-select: none;",r.dataset.processed=!0;}}),Array.from(document.querySelectorAll(".station-selected-turnarounds__turnarounds-details__turnaround-details .ui-badge")).forEach(r=>{if(!r.dataset.processed){const i=r.id.match(/turnaround-details-badge-([0-9]+)/)[1];r.addEventListener("click",()=>{window.open(`https://metabase.tarmactechnologies.com/dashboard/7-turnaround-deepdive?turnaround_id=${i}`);}),r.style="cursor: pointer; user-select: none;",r.dataset.processed=!0;}});}function c(){new MutationObserver(r=>{r.forEach(i=>{i.addedNodes.length&&s();});}).observe(document.body,{childList:!0,subtree:!0});}s(),c(),console.log("[TT Userscript] Module loaded");}function _(){function a(s,c){const r=document.evaluate('.//label[contains(., "Task Additional Information")]',c,null,XPathResult.ANY_TYPE,null).iterateNext();if(!r){console.error("[TT Userscript] Add info label not found");return}function i(e,t){const u=t.split(`
`).map(d=>d.split(",")[0]);if(u.some((d,n)=>u.indexOf(d)<n))return e.alert("Duplicate hard labels not allowed!"),!1;for(const d of c.querySelectorAll(".task-additional-information-tbody button.delete-task-additional-information"))d.click();for(const[d,n]of t.split(`
`).entries()){if(n.trim()==="")continue;const o=n.split(",");if(o.length<3)return e.alert("Three or four columns required!"),!1;d>0&&c.querySelector(".add-task-additional-information").click();const[l,p,b]=o,m=Array.from(c.querySelectorAll(".task-additional-information-tbody tr")).at(-1),g=m.querySelector(`select[name="normal-${s}-task-additional-information-label-id"]`),y=Array.from(g.options).find(f=>f.label.toLowerCase()===l.toLowerCase());y===void 0?console.warn(`[TT Userscript] Could not find label ${l}`):y.selected=!0;const w=m.querySelector(`input[name="normal-${s}-task-additional-information-custom-label"]`);w.value=p;const k=m.querySelector(`select[name="normal-${s}-task-additional-information-type"]`),h=Array.from(k.options).find(f=>f.label.toLowerCase()===b.toLowerCase());if(h===void 0?console.warn(`[TT Userscript] Could not find type ${b}`):h.selected=!0,o.length>3){const f=o[3].toLowerCase()==="true";m.querySelector('input[type="checkbox"]').checked=f;}}return !0}r.addEventListener("click",()=>{const e=window.open("","","width=800, height=400, scrollbars=yes");e.document.body.innerHTML='<textarea name="addinfos" id="addinfos" rows="10" style="display: block; height: calc(100% - 20px); width: 100%; padding: 5px;"></textarea><button id="submit">Submit</button>';let t="";for(const d of c.querySelectorAll(".task-additional-information-tbody tr")){const n=d.querySelector(`select[name="normal-${s}-task-additional-information-label-id"]`).selectedOptions,o=n.length>0?n[0].label:"",l=d.querySelector(`input[name="normal-${s}-task-additional-information-custom-label"]`).value,p=d.querySelector(`select[name="normal-${s}-task-additional-information-type"]`).selectedOptions,b=p.length>0?p[0].label:"",m=d.querySelector('input[type="checkbox"]').checked?"true":"false";t+=`${o},${l},${b},${m}
`;}t===`,,Checkbox,false
`&&(t="");const u=e.document.getElementById("addinfos");u.value=t,e.document.getElementById("submit").addEventListener("click",()=>{i(e,u.value)&&e.close();});}),r.style="cursor: pointer; user-select: none;";}for(const s of ["above","below"])for(const c of document.querySelectorAll(`#normal-${s}-table-body tr.row-id`))a(s,c);document.querySelector('button[data-action="add"][data-target="#normal-above-table"]').addEventListener("click",s=>{s.stopPropagation(),addRow("#normal-above-table");const c=Array.from(document.querySelectorAll("#normal-above-table-body tr.row-id")).at(-1);a("above",c);}),document.querySelector('button[data-action="add"][data-target="#normal-below-table"]').addEventListener("click",s=>{s.stopPropagation(),addRow("#normal-below-table");const c=Array.from(document.querySelectorAll("#normal-below-table-body tr.row-id")).at(-1);a("below",c);}),console.log("[TT Userscript] Critical path module loaded");}function x(a="admin"){new MutationObserver(c=>{for(const r of c)if(r.type==="childList")for(const i of r.addedNodes){const e=i.querySelector("a").href.match(/\/([0-9]+)\//)[1],t=i.children[1];t.addEventListener("click",()=>{window.open(`https://${a}.tarmactechnologies.com/users/customuser/${e}`);}),t.style="cursor: pointer; user-select: none;";}}).observe(document.querySelector("#users-list tbody"),{childList:!0,subtree:!0}),console.log("[TT Userscript] Users module loaded");}(function(){const a=window.location.hostname,s=window.location.pathname;/^(?:dev-)?backoffice.tarmactechnologies.com$/.test(a)&&(/^\/(?:specific_)?critical_path\/(?:[0-9]+\/)?(?:edit|add|new)/.test(s)&&_(),/\/users/i.test(s)&&x(/^dev-backoffice/.test(a)?"dev-admin":"admin")),/^(?:dev-)?admin.tarmactechnologies.com$/.test(a)&&(/^\/users\/customuser\/[0-9]+\/change/.test(s)&&E(),/^\/tarmac\/company\/(?:[0-9]+\/change|add)/.test(s)&&A(),/^\/tarmac\/partnertaskrule\/(?:add|[0-9]+\/change)/.test(s)&&$()),/(?:dev-)?agoa.tarmactechnologies.com/.test(a)&&/^\/(?:agoa|station)?$/.test(s)&&C(/^dev-agoa/.test(a)?"dev-admin":"admin");})();

})();