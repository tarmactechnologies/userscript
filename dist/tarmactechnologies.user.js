// ==UserScript==
// @name         Tarmac Technologies
// @version      3.0.0
// @author       Victor Colomb
// @description  Miscellaneous Tarmac Technologies Utilities
// @icon         https://static-tarmac.s3.amazonaws.com/img/favicon.ico
// @downloadURL  https://github.com/tarmactechnologies/userscript/raw/main/dist/tarmactechnologies.user.js
// @updateURL    https://github.com/tarmactechnologies/userscript/raw/main/dist/tarmactechnologies.meta.js
// @match        https://backoffice.tarmactechnologies.com/*
// @match        https://dev-backoffice.tarmactechnologies.com/*
// @match        https://admin.tarmactechnologies.com/*
// @match        https://dev-admin.tarmactechnologies.com/*
// @match        https://agoa.tarmactechnologies.com/*
// @match        https://dev-agoa.tarmactechnologies.com/*
// ==/UserScript==

(function () {
	'use strict';

	function S(){const l=document.querySelector('label[for="id_business_groups"]'),s=document.querySelector('select[name="business_groups"]'),r=document.querySelector('input[name="name"]').value,d=[[l,s,()=>r]];for(const e of document.querySelectorAll('select[name$="-business_groups"]')){e.insertAdjacentHTML("afterend",`<span class="related-widget-wrapper-link add-related" id="popup-${e.id}" title="Add another Company Business Group"><img src="https://static-tarmac.s3.amazonaws.com/admin/img/icon-yes.svg" alt="Popup"></span>`);const t=document.getElementById(`popup-${e.id}`);d.push([t,e,()=>document.querySelector(`select[name="${e.name.match(/^(.*)-business_groups$/)[1]}-related_company"]`).selectedOptions[0].innerHTML+" (related)"]);}for(const[e,t,u]of d){let c=function(n){for(const o of t.options)o.selected=!1;for(let o of n){if(o=o.trim().toUpperCase().match(/([A-Z0-9]{2}).*([A-Z]{3})/),!o)continue;o=`${o[1]} - ${o[2]}`;const i=Array.from(t.options).find(p=>p.label===o);i===void 0?console.warn(`[TT Userscript] Cound not find company business group ${o}`):i.selected=!0;}};e.addEventListener("click",()=>{const n=Array.from(t.options).filter(i=>i.selected).map(i=>i.label),o=window.open("","","width=800, height=400");o.document.title=`${u()} | Company Business Groups`,o.document.body.innerHTML=`<label for="cbg" style="display: block;">Company Business Groups</label><textarea type="text" name="cbg" id="cbg" style="width: 100%; height: calc(100% - 60px); margin-bottom: 15px;">${n.join(`
`)}</textarea><br><button id="submit">Submit</button>`,o.document.querySelector("#submit").addEventListener("click",()=>{c(o.document.querySelector("#cbg").value.split(`
`)),o.close();}),window.addEventListener("beforeunload",()=>{o.close();}),o.document.addEventListener("keydown",i=>{i.ctrlKey&&i.key==="Enter"&&o.document.querySelector("#submit").click(),i.key==="Escape"&&o.close();});}),e.style="cursor: pointer; user-select: none;";}}function A(){S(),console.log("[TT Userscript] Companies module loaded");}function T(){const l=document.querySelector('label[for="id_airlines"]'),s=document.querySelector('select[name="airlines"]'),r=document.querySelector('input[name="information_code"]').value;function d(a){for(const e of s.options)e.selected=!1;for(let e of a){if(e=e.trim().toUpperCase(),!e)continue;const t=Array.from(s.options).find(u=>u.label.substring(1,3)===e);t===void 0?console.warn(`[TT Userscript] Cound not find airline ${e}`):t.selected=!0;}}l.addEventListener("click",()=>{const a=Array.from(s.options).filter(t=>t.selected).map(t=>t.label.substring(1,3)),e=window.open("","","width=400, height=400");e.document.title=`${r} | Airlines`,e.document.body.innerHTML=`<label for="cbg" style="display: block;">Airlines</label><textarea type="text" name="airlines" id="airlines" style="width: 100%; height: calc(100% - 60px); margin-bottom: 15px;">${a.join(`
`)}</textarea><br><button id="submit">Submit</button>`,e.document.querySelector("#submit").addEventListener("click",()=>{d(e.document.querySelector("#airlines").value.split(`
`)),e.close();}),window.addEventListener("beforeunload",()=>{e.close();}),e.document.addEventListener("keydown",t=>{t.ctrlKey&&t.key==="Enter"&&e.document.querySelector("#submit").click(),t.key==="Escape"&&e.close();});}),l.style="cursor: pointer; user-select: none;";}function q(){const l=document.querySelector('label[for="id_airports"]'),s=document.querySelector('select[name="airports"]'),r=document.querySelector('input[name="information_code"]').value;function d(a){for(const e of s.options)e.selected=!1;for(let e of a){if(e=e.trim().toUpperCase(),!e)continue;const t=Array.from(s.options).find(u=>u.label.substring(0,3)===e);t===void 0?console.warn(`[TT Userscript] Cound not find airport ${e}`):t.selected=!0;}}l.addEventListener("click",()=>{const a=Array.from(s.options).filter(t=>t.selected).map(t=>t.label.substring(0,3)),e=window.open("","","width=400, height=400");e.document.title=`${r} | Airlines`,e.document.body.innerHTML=`<label for="cbg" style="display: block;">Airports</label><textarea type="text" name="airports" id="airports" style="width: 100%; height: calc(100% - 60px); margin-bottom: 15px;">${a.join(`
`)}</textarea><br><button id="submit">Submit</button>`,e.document.querySelector("#submit").addEventListener("click",()=>{d(e.document.querySelector("#airports").value.split(`
`)),e.close();}),window.addEventListener("beforeunload",()=>{e.close();}),e.document.addEventListener("keydown",t=>{t.ctrlKey&&t.key==="Enter"&&e.document.querySelector("#submit").click(),t.key==="Escape"&&e.close();});}),l.style="cursor: pointer; user-select: none;";}function $(){T(),q(),console.log("[TT Userscript] Partner Task Rules module loaded");}function v(){const l=document.querySelector('label[for="id_business_groups"]'),s=document.querySelector('select[name="business_groups"]'),r=document.querySelector('input[name="username"]').value;function d(a,e,t,u,c){for(const n of s.options)n.selected=!1;for(const n of a){if(!n)continue;const o=Array.from(s.options).find(i=>i.label===`AIRLINE ${n.toUpperCase()}`);o===void 0?console.warn(`[TT Userscript] Cound not find airline ${n}`):o.selected=!0;}for(const n of e){if(!n)continue;const o=Array.from(s.options).find(i=>i.label===`AIRPORT ${n.toUpperCase()}`);o===void 0?console.warn(`[TT Userscript] Cound not find airport ${n}`):o.selected=!0;}for(const n of t){if(!n)continue;const o=Array.from(s.options).find(i=>i.label===`HANDLER ${n.toUpperCase()}`);o===void 0?console.warn(`[TT Userscript] Cound not find handler ${n}`):o.selected=!0;}for(const n of u){if(!n)continue;const o=Array.from(s.options).find(i=>i.label===`POSITION ${n.toUpperCase()}`);o===void 0?console.warn(`[TT Userscript] Cound not find position ${n}`):o.selected=!0;}for(const n of c){const o=Array.from(s.options).find(i=>i.label===n);o===void 0?console.error(`[TT Userscript] Could not find business group ${n}`):o.selected=!0;}}l.addEventListener("click",()=>{const a=[],e=[],t=[],u=[],c=[];for(const o of s.options){if(!o.selected)continue;const[i,p]=o.label.split(" ");switch(i){case"AIRLINE":a.push(p);break;case"AIRPORT":e.push(p);break;case"HANDLER":t.push(p);break;case"POSITION":u.push(p);break;default:console.warn(`Unknown business group type ${i} (name = ${p})`),c.push(o.label);}}const n=window.open("","","width=800, height=400, scrollbars=yes");n.document.title=`${r} | Business Groups`,n.document.body.innerHTML=`<label for="airlines" style="display: block;">Airlines</label><input type="text" name="airlines" id="airlines" value="${a.join(",")}" style="width: 100%; margin-bottom: 15px;" /><br>`,n.document.body.innerHTML+=`<label for="airports" style="display: block;">Airports</label><input type="text" name="airports" id="airports" value="${e.join(",")}" style="width: 100%; margin-bottom: 15px;" /><br>`,n.document.body.innerHTML+=`<label for="handlers" style="display: block;">Handlers</label><input type="text" name="handlers" id="handlers" value="${t.join(",")}" style="width: 100%; margin-bottom: 15px;" /><br>`,n.document.body.innerHTML+=`<label for="positions" style="display: block;">Positions</label><input type="text" name="positions" id="positions" value="${u.join(",")}" style="width: 100%; margin-bottom: 15px;" /><br>`,n.document.body.innerHTML+='<button id="submit">Submit</button>',n.document.querySelector("#submit").addEventListener("click",()=>{d(n.document.querySelector("#airlines").value.split(/[ ,]+/),n.document.querySelector("#airports").value.split(/[ ,]+/),n.document.querySelector("#handlers").value.split(/[ ,]+/),n.document.querySelector("#positions").value.split(/[ ,]+/),c),n.close();}),window.addEventListener("beforeunload",()=>{n.close();}),n.document.addEventListener("keydown",o=>{o.ctrlKey&&o.key==="Enter"&&n.document.querySelector("#submit").click(),o.key==="Escape"&&n.close();});}),l.style="cursor: pointer; user-select: none;";}function L(){const l=document.querySelector('label[for="id_company_business_groups"]'),s=document.querySelector('select[name="company_business_groups"]'),r=document.querySelector('input[name="username"]').value;function d(a){for(const e of s.options)e.selected=!1;for(let e of a){if(e=e.trim().toUpperCase().match(/([A-Z0-9]{2}).*([A-Z]{3})/),!e)continue;e=`${e[1]} - ${e[2]}`;const t=Array.from(s.options).find(u=>u.label===e);t===void 0?console.warn(`[TT Userscript] Cound not find company business group ${e}`):t.selected=!0;}}l.addEventListener("click",()=>{const a=Array.from(s.options).filter(t=>t.selected).map(t=>t.label),e=window.open("","","width=800, height=400");e.document.title=`${r} | Company Business Groups`,e.document.body.innerHTML=`<label for="cbg" style="display: block;">Company Business Groups</label><textarea type="text" name="cbg" id="cbg" style="width: 100%; height: calc(100% - 60px); margin-bottom: 15px;">${a.join(`
`)}</textarea><br><button id="submit">Submit</button>`,e.document.querySelector("#submit").addEventListener("click",()=>{d(e.document.querySelector("#cbg").value.split(`
`)),e.close();}),window.addEventListener("beforeunload",()=>{e.close();}),e.document.addEventListener("keydown",t=>{t.ctrlKey&&t.key==="Enter"&&e.document.querySelector("#submit").click(),t.key==="Escape"&&e.close();});}),l.style="cursor: pointer; user-select: none;";}function E(){v(),L(),console.log("[TT Userscript] Users module loaded");}function x(l="admin"){function s(){Array.from(document.querySelectorAll('[id^="turnaroundDetailHeaderTurnaroundActualAirport"]')).forEach(r=>{if(!r.dataset.processed){const d=r.id.match(/turnaroundDetailHeaderTurnaroundActualAirport([0-9]+)/)[1];r.addEventListener("click",()=>{window.open(`https://${l}.tarmactechnologies.com/tarmac/turnaround/${d}`);}),r.style="cursor: pointer; user-select: none;",r.dataset.processed=!0;}});}setInterval(s,1e3),console.log("[TT Userscript] Module loaded");}function C(){function l(s,r){const d=document.evaluate('.//label[contains(., "Task Additional Information")]',r,null,XPathResult.ANY_TYPE,null).iterateNext();if(!d){console.error("[TT Userscript] Add info label not found");return}function a(e,t){const u=t.split(`
`).map(c=>c.split(",")[0]);if(u.some((c,n)=>u.indexOf(c)<n))return e.alert("Duplicate hard labels not allowed!"),!1;for(const c of r.querySelectorAll(".task-additional-information-tbody button.delete-task-additional-information"))c.click();for(const[c,n]of t.split(`
`).entries()){if(n.trim()==="")continue;const o=n.split(",");if(o.length<3)return e.alert("Three or four columns required!"),!1;c>0&&r.querySelector(".add-task-additional-information").click();const[i,p,b]=o,m=Array.from(r.querySelectorAll(".task-additional-information-tbody tr")).at(-1),g=m.querySelector(`select[name="normal-${s}-task-additional-information-label-id"]`),y=Array.from(g.options).find(f=>f.label.toLowerCase()===i.toLowerCase());y===void 0?console.warn(`[TT Userscript] Could not find label ${i}`):y.selected=!0;const w=m.querySelector(`input[name="normal-${s}-task-additional-information-custom-label"]`);w.value=p;const k=m.querySelector(`select[name="normal-${s}-task-additional-information-type"]`),h=Array.from(k.options).find(f=>f.label.toLowerCase()===b.toLowerCase());if(h===void 0?console.warn(`[TT Userscript] Could not find type ${b}`):h.selected=!0,o.length>3){const f=o[3].toLowerCase()==="true";m.querySelector('input[type="checkbox"]').checked=f;}}return !0}d.addEventListener("click",()=>{const e=window.open("","","width=800, height=400, scrollbars=yes");e.document.body.innerHTML='<textarea name="addinfos" id="addinfos" rows="10" style="display: block; height: calc(100% - 20px); width: 100%; padding: 5px;"></textarea><button id="submit">Submit</button>';let t="";for(const c of r.querySelectorAll(".task-additional-information-tbody tr")){const n=c.querySelector(`select[name="normal-${s}-task-additional-information-label-id"]`).selectedOptions,o=n.length>0?n[0].label:"",i=c.querySelector(`input[name="normal-${s}-task-additional-information-custom-label"]`).value,p=c.querySelector(`select[name="normal-${s}-task-additional-information-type"]`).selectedOptions,b=p.length>0?p[0].label:"",m=c.querySelector('input[type="checkbox"]').checked?"true":"false";t+=`${o},${i},${b},${m}
`;}t===`,,Checkbox,false
`&&(t="");const u=e.document.getElementById("addinfos");u.value=t,e.document.getElementById("submit").addEventListener("click",()=>{a(e,u.value)&&e.close();});}),d.style="cursor: pointer; user-select: none;";}for(const s of ["above","below"])for(const r of document.querySelectorAll(`#normal-${s}-table-body tr.row-id`))l(s,r);document.querySelector('button[data-action="add"][data-target="#normal-above-table"]').addEventListener("click",s=>{s.stopPropagation(),addRow("#normal-above-table");const r=Array.from(document.querySelectorAll("#normal-above-table-body tr.row-id")).at(-1);l("above",r);}),document.querySelector('button[data-action="add"][data-target="#normal-below-table"]').addEventListener("click",s=>{s.stopPropagation(),addRow("#normal-below-table");const r=Array.from(document.querySelectorAll("#normal-below-table-body tr.row-id")).at(-1);l("below",r);}),console.log("[TT Userscript] Critical path module loaded");}function U(l="admin"){new MutationObserver(r=>{for(const d of r)if(d.type==="childList")for(const a of d.addedNodes){const e=a.querySelector("a").href.match(/\/([0-9]+)\//)[1],t=a.children[1];t.addEventListener("click",()=>{window.open(`https://${l}.tarmactechnologies.com/users/customuser/${e}`);}),t.style="cursor: pointer; user-select: none;";}}).observe(document.querySelector("#users-list tbody"),{childList:!0,subtree:!0}),console.log("[TT Userscript] Users module loaded");}(function(){const l=window.location.hostname,s=window.location.pathname;/^(?:dev-)?backoffice.tarmactechnologies.com$/.test(l)&&(/^\/(?:specific_)?critical_path\/(?:[0-9]+\/)?(?:edit|add|new)/.test(s)&&C(),/\/users/i.test(s)&&U(/^dev-backoffice/.test(l)?"dev-admin":"admin")),/^(?:dev-)?admin.tarmactechnologies.com$/.test(l)&&(/^\/users\/customuser\/[0-9]+\/change/.test(s)&&E(),/^\/tarmac\/company\/(?:[0-9]+\/change|add)/.test(s)&&A(),/^\/tarmac\/partnertaskrule\/(?:add|[0-9]+\/change)/.test(s)&&(console.log("hear hear"),$())),/(?:dev-)?agoa.tarmactechnologies.com/.test(l)&&/^\/(?:agoa)?$/.test(s)&&x(/^dev-agoa/.test(l)?"dev-admin":"admin");})();

})();